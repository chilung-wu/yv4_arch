# OpenBMC Yosemite4 é–‹æ©Ÿæµç¨‹è©³ç´°åˆ†æ

## ç¸½è¦½

OpenBMC Yosemite4 æ¡ç”¨ç¨ç‰¹çš„ **static-norootfs** é–‹æ©Ÿæ¶æ§‹ï¼Œé€™èˆ‡å‚³çµ±çš„ Linux ç³»çµ±æœ‰æ ¹æœ¬æ€§çš„å·®ç•°ã€‚æœ¬æ–‡ä»¶æ·±å…¥åˆ†ææ•´å€‹é–‹æ©Ÿæµç¨‹ï¼Œå¾ç¡¬é«”ä¸Šé›»åˆ°ç³»çµ±å®Œå…¨å°±ç·’çš„æ¯å€‹éšæ®µã€‚

## æ ¸å¿ƒæ¶æ§‹ç‰¹é»

### ğŸ”‘ é—œéµå·®ç•°ï¼šç„¡ switch_root è¨­è¨ˆ

```bash
# å‚³çµ± Linux é–‹æ©Ÿæµç¨‹
ROM â†’ U-Boot â†’ Kernel â†’ initramfs â†’ switch_root â†’ real rootfs â†’ systemd

# Yosemite4 static-norootfs æµç¨‹  
ROM â†’ U-Boot â†’ Kernel â†’ initramfs (å®Œæ•´ rootfs) â†’ systemd
                                 â†‘
                           ç„¡ switch_rootï¼
```

**é‡è¦è§€å¿µ**: Yosemite4 çš„ initramfs **å°±æ˜¯**å®Œæ•´ä¸”å”¯ä¸€çš„æ ¹æª”æ¡ˆç³»çµ±ï¼Œä¸å­˜åœ¨"åˆ‡æ›"åˆ°å…¶ä»–æ ¹æª”æ¡ˆç³»çµ±çš„éç¨‹ã€‚

## è©³ç´°é–‹æ©Ÿéšæ®µåˆ†æ

### éšæ®µ 1: ç¡¬é«”å•Ÿå‹•å’Œ ROM Code (T0-T1: 0-500ms)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ASPEED AST2620-A3 SoC         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          ROM Code                   â”‚ â”‚
â”‚  â”‚  ãƒ»åˆå§‹åŒ–åŸºæœ¬ CPU æš«å­˜å™¨             â”‚ â”‚
â”‚  â”‚  ãƒ»è¨­å®š SRAM è¨˜æ†¶é«”æ§åˆ¶å™¨            â”‚ â”‚
â”‚  â”‚  ãƒ»å¾ SPI Flash è¼‰å…¥ U-Boot SPL     â”‚ â”‚
â”‚  â”‚  ãƒ»é©—è­‰ SPL ç°½ç«  (Secure Boot)      â”‚ â”‚
â”‚  â”‚  ãƒ»è·³è½‰åˆ° SPL åŸ·è¡Œä½å€               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æŠ€è¡“ç´°ç¯€
- **åŸ·è¡Œä½ç½®**: SoC å…§å»º ROM (16KB)
- **è¨˜æ†¶é«”**: ä½¿ç”¨å…§å»º SRAM (64KB)
- **è¼‰å…¥ç›®æ¨™**: U-Boot SPL (å‰ 512KB)
- **é©—è­‰æ©Ÿåˆ¶**: RSA-2048 æ•¸ä½ç°½ç« 

```c
// ROM Code å½ä»£ç¢¼æµç¨‹
void rom_boot_sequence() {
    init_cpu_registers();
    init_sram_controller();
    
    if (secure_boot_enabled()) {
        if (!verify_spl_signature()) {
            enter_recovery_mode();
            return;
        }
    }
    
    load_spl_from_flash(FLASH_SPL_OFFSET, SRAM_BASE);
    jump_to_spl(SRAM_BASE);
}
```

### éšæ®µ 2: U-Boot SPL åŸ·è¡Œ (T1-T2: 500ms-1.5s)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              U-Boot SPL                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DDR4 è¨˜æ†¶é«”æ§åˆ¶å™¨åˆå§‹åŒ–             â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ æ™‚è„ˆé…ç½® (2400MHz)             â”‚ â”‚  
â”‚  â”‚  â”œâ”€â”€ æ™‚åºåƒæ•¸èª¿æ•´                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¨˜æ†¶é«”è¨“ç·´ (Training)          â”‚ â”‚
â”‚  â”‚  â””â”€â”€ ECC åˆå§‹åŒ– (å¯é¸)              â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  è¼‰å…¥ U-Boot Proper                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ å¾ Flash è®€å– 512KB            â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¤‡è£½åˆ° DDR4 è¨˜æ†¶é«”              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ é©—è­‰å®Œæ•´æ€§                     â”‚ â”‚
â”‚  â”‚  â””â”€â”€ è·³è½‰åŸ·è¡Œ                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### SPL é—œéµä»»å‹™
1. **DDR4 åˆå§‹åŒ–**: å¾ 64KB SRAM æ“´å±•åˆ° 1024MB DDR4 (910MB å¯ç”¨)
2. **æ™‚è„ˆæ¨¹è¨­å®š**: é…ç½®æ‰€æœ‰å‘¨é‚Šæ™‚è„ˆ
3. **è¼‰å…¥ U-Boot**: æº–å‚™å®Œæ•´çš„é–‹æ©Ÿè¼‰å…¥å™¨

```c
// U-Boot SPL ä¸»è¦æµç¨‹
void spl_board_init() {
    // 1. åŸºæœ¬ç¡¬é«”åˆå§‹åŒ–
    clock_init();
    pin_mux_init();
    
    // 2. DDR4 è¨˜æ†¶é«”åˆå§‹åŒ– - æœ€é—œéµæ­¥é©Ÿ
    ddr4_controller_init();
    ddr4_training();
    memory_test();
    
    // 3. è¼‰å…¥ U-Boot Proper
    load_uboot_proper();
    jump_to_uboot_proper();
}
```

### éšæ®µ 3: U-Boot Proper åŸ·è¡Œ (T2-T3: 1.5s-3.0s)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           U-Boot Proper                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç’°å¢ƒè®Šæ•¸è¼‰å…¥å’Œè™•ç†                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ å¾ Flash è¼‰å…¥ env              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ æª¢æŸ¥é–‹æ©Ÿæ¨¡å¼è¨­å®š               â”‚ â”‚
â”‚  â”‚  â””â”€â”€ è§£æé–‹æ©Ÿåƒæ•¸                   â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  FIT Image è¼‰å…¥                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¼‰å…¥ Kernel (vmlinux)          â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¼‰å…¥ Device Tree Blob          â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¼‰å…¥ Initramfs (å®Œæ•´rootfs)    â”‚ â”‚
â”‚  â”‚  â””â”€â”€ é©—è­‰æ•¸ä½ç°½ç«                    â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  å•Ÿå‹• Linux æ ¸å¿ƒ                    â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¨­å®šæ ¸å¿ƒåƒæ•¸                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¨­å®šè¨˜æ†¶é«”æ˜ å°„                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€ åŸ·è¡Œæ ¸å¿ƒ                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### FIT Image çµæ§‹
```bash
FIT Image Layout (å¯¦éš›):
â”œâ”€â”€ Header (1KB)
â”œâ”€â”€ Kernel Image (~4.4MB)
â”‚   â””â”€â”€ vmlinux (uncompressed)
â”œâ”€â”€ Device Tree Blob (~71.5KB)  
â”‚   â””â”€â”€ aspeed-bmc-facebook-yosemite4.dtb
â””â”€â”€ Initramfs (~46.7MB)
    â””â”€â”€ å®Œæ•´çš„ OpenBMC rootfs (cpio.zst å£“ç¸®)
```

#### é–‹æ©Ÿåƒæ•¸é…ç½®
```bash
# U-Boot ç’°å¢ƒè®Šæ•¸ (é—œéµåƒæ•¸)
bootargs=console=ttyS4,115200n8 root=/dev/ram rw 
bootcmd=bootm 0x20080000
loadaddr=0x83000000
fdtaddr=0x83100000  
rdaddr=0x84000000

# FIT Image è¼‰å…¥ä½å€
fit_loadaddr=0x20080000
```

### éšæ®µ 4: Linux æ ¸å¿ƒå•Ÿå‹• (T3-T4: 3.0s-4.5s)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Linux Kernel                 â”‚  
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ ¸å¿ƒè§£å£“ç¸®å’Œé‡å®šä½                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è§£å£“ç¸® vmlinux                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ å»ºç«‹é è¡¨                       â”‚ â”‚
â”‚  â”‚  â””â”€â”€ å•Ÿç”¨ MMU                       â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  ç¡¬é«”å­ç³»çµ±åˆå§‹åŒ–                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ ä¸­æ–·æ§åˆ¶å™¨ (GIC-400)           â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¨ˆæ™‚å™¨ (ARM Generic Timer)     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ DMA æ§åˆ¶å™¨                     â”‚ â”‚
â”‚  â”‚  â””â”€â”€ åŸºæœ¬ I/O å­ç³»çµ±                â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  Initramfs æ›è¼‰                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è§£å£“ç¸® initramfs               â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ å»ºç«‹ tmpfs rootfs              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è§£å£“ç¸®æª”æ¡ˆåˆ° tmpfs             â”‚ â”‚
â”‚  â”‚  â””â”€â”€ è¨­å®šç‚ºæ ¹æª”æ¡ˆç³»çµ±               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒè¼‰å…¥è¨˜æ†¶é«”é…ç½®
```
DDR4 è¨˜æ†¶é«”é…ç½® (1024MB):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 0x80000000
â”‚         æ ¸å¿ƒæ˜ åƒæª” (~10MB)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 0x80A00000  
â”‚         initramfs (~70MB)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 0x85000000
â”‚         æ ¸å¿ƒè³‡æ–™çµæ§‹ (~100MB)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 0x8B400000
â”‚         tmpfs rootfs (~400MB)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 0xA4400000
â”‚         å¯ç”¨è¨˜æ†¶é«” (~400MB)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 0xBFFFFFFF
```

### éšæ®µ 5: Static-NoRootFS åˆå§‹åŒ– (T4-T5: 4.5s-8.0s)

é€™æ˜¯ Yosemite4 æœ€ç¨ç‰¹çš„éšæ®µï¼Œç”± `phosphor-static-norootfs-init` å¥—ä»¶æä¾›çš„ `/init` è…³æœ¬åŸ·è¡Œã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      phosphor-static-norootfs-init      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /init ä¸»æ§åˆ¶è…³æœ¬                   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ è¨­å®šåŸºæœ¬ç’°å¢ƒè®Šæ•¸               â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ æƒæå¯ç”¨çš„åˆå§‹åŒ–è…³æœ¬           â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ æŒ‰é †åºåŸ·è¡Œè…³æœ¬                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€ è½‰äº¤æ§åˆ¶æ¬Šçµ¦ systemd           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è©³ç´°åˆå§‹åŒ–è…³æœ¬åºåˆ—

##### 5.1 åŸ·è¡Œ 10-early-mounts
```bash
#!/bin/sh
# æª”æ¡ˆ: /etc/init.d/10-early-mounts

# æ›è¼‰åŸºæœ¬çš„è™›æ“¬æª”æ¡ˆç³»çµ±
mount -t devtmpfs devtmpfs /dev
mount -t sysfs sysfs /sys  
mount -t proc proc /proc
mount -t tmpfs tmpfs /run -o mode=755,nodev,nosuid,strictatime

# å»ºç«‹åŸºæœ¬ç›®éŒ„çµæ§‹
mkdir -p /run/lock /run/log
chmod 755 /run/lock
```

**ç›®çš„**: å»ºç«‹åŸºæœ¬çš„è™›æ“¬æª”æ¡ˆç³»çµ±ï¼Œç‚ºå¾ŒçºŒæ“ä½œæä¾›å¿…è¦çš„ç³»çµ±ä»‹é¢ã€‚

##### 5.2 åŸ·è¡Œ 20-udev
```bash
#!/bin/sh  
# æª”æ¡ˆ: /etc/init.d/20-udev

# å•Ÿå‹• udev é€²è¡Œè£ç½®ç®¡ç†
echo "Starting udev..."
/lib/systemd/systemd-udevd --daemon

# è§¸ç™¼è£ç½®åµæ¸¬
udevadm trigger --action=add
udevadm settle --timeout=10
```

**ç›®çš„**: åˆå§‹åŒ–è£ç½®ç®¡ç†å­ç³»çµ±ï¼Œåµæ¸¬å’Œå»ºç«‹ç¡¬é«”è£ç½®ç¯€é»ã€‚

##### 5.3 åŸ·è¡Œ 21-factory-reset
```bash
#!/bin/sh
# æª”æ¡ˆ: /etc/init.d/21-factory-reset

check_factory_reset() {
    # æª¢æŸ¥ GPIO é‡ç½®è¨Šè™Ÿ
    if [ -f /sys/class/gpio/gpio123/value ]; then
        reset_signal=$(cat /sys/class/gpio/gpio123/value)
        if [ "$reset_signal" = "0" ]; then
            return 0  # éœ€è¦é‡ç½®
        fi
    fi
    
    # æª¢æŸ¥ U-Boot ç’°å¢ƒè®Šæ•¸
    if fw_printenv openbmconce | grep -q "factory-reset"; then
        fw_setenv openbmconce  # æ¸…é™¤æ¨™è¨˜
        return 0  # éœ€è¦é‡ç½®
    fi
    
    return 1  # ä¸éœ€è¦é‡ç½®
}

if check_factory_reset; then
    echo "Factory reset requested, formatting persistent storage..."
    format_persistent_storage
fi
```

**ç›®çš„**: æª¢æŸ¥æ˜¯å¦éœ€è¦åŸ·è¡Œå·¥å» é‡ç½®ï¼Œæ¸…é™¤æŒä¹…åŒ–è³‡æ–™ã€‚

##### 5.4 åŸ·è¡Œ 30-ubiattach-or-format
```bash
#!/bin/sh
# æª”æ¡ˆ: /etc/init.d/30-ubiattach-or-format

RWFS_MTD="/dev/mtd/rwfs"
PERSIST_DIR="/run/mnt-persist"

format_rwfs() {
    echo "Formatting RWFS partition..."
    ubiformat --yes $RWFS_MTD
    ubiattach -p $RWFS_MTD
    ubimkvol /dev/ubi0 -N rwfs -m
    mount -t ubifs ubi0:rwfs $PERSIST_DIR -o sync,compr=zstd
}

mount_rwfs() {
    echo "Mounting existing RWFS..."
    ubiattach -p $RWFS_MTD
    mount -t ubifs ubi0:rwfs $PERSIST_DIR -o sync,compr=zstd
}

# å˜—è©¦æ›è¼‰ç¾æœ‰çš„ UBIFSï¼Œå¤±æ•—å‰‡æ ¼å¼åŒ–
if ! mount_rwfs; then
    echo "RWFS mount failed, formatting..."
    format_rwfs
fi
```

**ç›®çš„**: æº–å‚™æŒä¹…åŒ–å„²å­˜ï¼Œæ›è¼‰æˆ–å»ºç«‹ UBIFS æª”æ¡ˆç³»çµ±ã€‚

##### 5.5 åŸ·è¡Œ 50-mount-persistent
```bash
#!/bin/sh
# æª”æ¡ˆ: /etc/init.d/50-mount-persistent

PERSIST="/run/mnt-persist"
PERSISTENT_DIRS="/var /etc /home"

mount_overlay() {
    local dir=$1
    local lower_dir="$dir"
    local upper_dir="$PERSIST${dir}-data"  
    local work_dir="$PERSIST${dir}-work"
    
    # å»ºç«‹å¿…è¦çš„ç›®éŒ„
    mkdir -p "$upper_dir" "$work_dir"
    
    # æ›è¼‰ OverlayFS
    mount -t overlay overlay "$dir" \
        -o lowerdir="$lower_dir",upperdir="$upper_dir",workdir="$work_dir"
    
    echo "Mounted overlay for $dir"
}

# ç‚ºæ¯å€‹æŒä¹…åŒ–ç›®éŒ„å»ºç«‹ overlay æ›è¼‰
for dir in $PERSISTENT_DIRS; do
    mount_overlay "$dir"
done
```

**ç›®çš„**: å»ºç«‹ OverlayFS æ›è¼‰ï¼Œå¯¦ç¾é¸æ“‡æ€§ç›®éŒ„æŒä¹…åŒ–ã€‚

#### OverlayFS æ¶æ§‹è©³è§£

```
OverlayFS ä¸‰å±¤çµæ§‹ç¯„ä¾‹ (/var ç›®éŒ„):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä½¿ç”¨è€…è¦–è§’: /var                â”‚  â† çµ±ä¸€æª¢è¦–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Upper Dir: /run/mnt-persist/var-data    â”‚  â† å¯å¯«å±¤ (Flash)
â”‚ â”œâ”€â”€ cache/                              â”‚
â”‚ â”œâ”€â”€ log/                                â”‚  
â”‚ â””â”€â”€ lib/                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Lower Dir: /var (ä¾†è‡ª initramfs)         â”‚  â† å”¯è®€å±¤ (è¨˜æ†¶é«”)
â”‚ â”œâ”€â”€ empty/ (é è¨­ç©ºç›®éŒ„)                  â”‚
â”‚ â”œâ”€â”€ lib/ (é è¨­å‡½å¼åº«æª”æ¡ˆ)                â”‚
â”‚ â””â”€â”€ run/ (åŸ·è¡Œæ™‚ç›®éŒ„)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Work Dir: /run/mnt-persist/var-work     â”‚  â† OverlayFS å·¥ä½œç›®éŒ„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æª”æ¡ˆæ“ä½œè¡Œç‚º
```bash
# è®€å–æª”æ¡ˆå„ªå…ˆé †åº:
# 1. Upper Dir (å¦‚æœæª”æ¡ˆå­˜åœ¨)
# 2. Lower Dir (å¦‚æœ Upper Dir æ²’æœ‰)

# å¯«å…¥æª”æ¡ˆè¡Œç‚º:
# 1. æ–°æª”æ¡ˆç›´æ¥å¯«å…¥ Upper Dir
# 2. ä¿®æ”¹ Lower Dir æª”æ¡ˆæ™‚å…ˆ Copy-up åˆ° Upper Dir

# åˆªé™¤æª”æ¡ˆè¡Œç‚º:
# 1. åœ¨ Upper Dir å»ºç«‹ whiteout æª”æ¡ˆæ¨™è¨˜åˆªé™¤
# 2. Lower Dir åŸæª”æ¡ˆä»å­˜åœ¨ä½†è¢«é®è”½
```

### éšæ®µ 6: systemd å•Ÿå‹• (T5-T6: 8.0s-12.0s)

```bash
# /init è…³æœ¬çš„æœ€å¾Œå‹•ä½œ
echo "Starting systemd..."
exec /lib/systemd/systemd
```

æ­¤æ™‚æ§åˆ¶æ¬Šå®Œå…¨è½‰äº¤çµ¦ systemdï¼Œé–‹å§‹æ­£å¸¸çš„ç³»çµ±æœå‹™ç®¡ç†æµç¨‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              systemd                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  åŸºæœ¬ç›®æ¨™å•Ÿå‹•                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ sysinit.target                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ basic.target                   â”‚ â”‚
â”‚  â”‚  â””â”€â”€ multi-user.target              â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  BMC ç‰¹å®šæœå‹™                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ phosphor-discovery             â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ phosphor-host-ipmid            â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ phosphor-chassis-state         â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ phosphor-bmc-state             â”‚ â”‚
â”‚  â”‚  â””â”€â”€ bmcweb.service                 â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  ç¶²è·¯å’Œç®¡ç†æœå‹™                     â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ systemd-networkd              â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ sshd.service                   â”‚ â”‚
â”‚  â”‚  â””â”€â”€ obmc-console-server            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é‡è¦ systemd æœå‹™èªªæ˜

##### BMC æ ¸å¿ƒæœå‹™
```bash
# phosphor-discovery.service - BMC æœå‹™ç™¼ç¾
# phosphor-host-ipmid.service - IPMI å‘½ä»¤è™•ç†  
# phosphor-chassis-state.service - æ©Ÿç®±ç‹€æ…‹ç®¡ç†
# phosphor-bmc-state.service - BMC ç‹€æ…‹ç®¡ç†
# bmcweb.service - Web ç®¡ç†ä»‹é¢å’Œ Redfish API
```

##### ç¶²è·¯æœå‹™
```bash
# systemd-networkd.service - ç¶²è·¯é…ç½®ç®¡ç†
# systemd-resolved.service - DNS è§£æ
# sshd.service - SSH é ç«¯å­˜å–
# obmc-console-server.service - ä¸»æ©Ÿæ§åˆ¶å°é‡å®šå‘
```

## é–‹æ©Ÿå®Œæˆç‹€æ…‹åˆ†æ

### æœ€çµ‚æª”æ¡ˆç³»çµ±æ›è¼‰ç‹€æ…‹

åŸ·è¡Œ `mount` å‘½ä»¤çš„çµæœï¼š
```bash
root@yosemite4:~# mount
rootfs on / type rootfs (rw,size=201832k,nr_inodes=50458)
devtmpfs on /dev type devtmpfs (rw,relatime,size=4096k,nr_inodes=1024,mode=755)
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
tmpfs on /run type tmpfs (rw,nosuid,nodev,mode=755)
ubi0:rwfs on /run/mnt-persist type ubifs (rw,relatime,compr=zstd)
overlay on /var type overlay (rw,relatime,lowerdir=/var,upperdir=/run/mnt-persist/var-data,workdir=/run/mnt-persist/var-work)
overlay on /etc type overlay (rw,relatime,lowerdir=/etc,upperdir=/run/mnt-persist/etc-data,workdir=/run/mnt-persist/etc-work)  
overlay on /home type overlay (rw,relatime,lowerdir=/home,upperdir=/run/mnt-persist/home-data,workdir=/run/mnt-persist/home-work)
```

### è¨˜æ†¶é«”ä½¿ç”¨åˆ†æ

```bash
root@yosemite4:~# free -h
              total        used        free      shared  buff/cache   available
Mem:           489M        180M         89M        8.0M        220M        285M
Swap:            0B          0B          0B
```

è¨˜æ†¶é«”åˆ†é…èªªæ˜ï¼š
- **ç¸½è¨˜æ†¶é«”**: 910MB (1024MB æ‰£é™¤ ECC å’Œç¡¬é«”ä¿ç•™)
- **å·²ä½¿ç”¨**: 180MB (æ ¸å¿ƒ + æœå‹™ + rootfs)
- **ç·©å­˜**: 220MB (æª”æ¡ˆç³»çµ±ç·©å­˜ + ç·©è¡å€)
- **å¯ç”¨**: 285MB (å¯¦éš›å¯åˆ†é…è¨˜æ†¶é«”)

### æŒä¹…åŒ–å„²å­˜ä½¿ç”¨

```bash
root@yosemite4:~# df -h /run/mnt-persist/
Filesystem      Size  Used Avail Use% Mounted on
ubi0:rwfs        10M  2.1M  7.6M  22% /run/mnt-persist
```

æŒä¹…åŒ–åˆ†å‰²å€ä½¿ç”¨æƒ…æ³ï¼š
- **ç¸½å®¹é‡**: 32MB (UBIFS åˆ†å‰²å€)
- **å·²ä½¿ç”¨**: 2.1MB (é…ç½®å’Œæ—¥èªŒæª”æ¡ˆ)
- **å¯ç”¨**: 7.6MB (å¯å„²å­˜æ›´å¤šæŒä¹…åŒ–è³‡æ–™)

## é—œéµæŠ€è¡“å„ªå‹¢åˆ†æ

### 1. é–‹æ©Ÿé€Ÿåº¦å„ªåŒ–
```
å‚³çµ±é–‹æ©Ÿ vs Static-NoRootFS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚³çµ±æ–¹å¼:                                â”‚
â”‚ initramfs â†’ fsck â†’ mount â†’ switch_root  â”‚
â”‚   2s    â†’  3s  â†’  1s   â†’     2s        â”‚
â”‚                                         â”‚
â”‚ Static-NoRootFS:                        â”‚
â”‚ initramfs â†’ overlay mounts              â”‚
â”‚   2s    â†’        3s                     â”‚
â”‚                                         â”‚
â”‚ ç¯€çœæ™‚é–“: ~3ç§’ (ç´„30%æ›´å¿«)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç³»çµ±ç©©å®šæ€§æå‡
- **ä¸å¯è®Šç³»çµ±æª”æ¡ˆ**: æ ¸å¿ƒç³»çµ±æª”æ¡ˆç„¡æ³•è¢«æ„å¤–ä¿®æ”¹
- **å¿«é€Ÿæ¢å¾©**: é‡å•Ÿå³å¯æ¢å¾©åˆ°ä¹¾æ·¨ç‹€æ…‹  
- **å·¥å» é‡ç½®**: æ¸…é™¤æŒä¹…åŒ–åˆ†å‰²å€å³å¯å®Œå…¨é‡ç½®

### 3. è¨˜æ†¶é«”æ•ˆç‡
- **å£“ç¸®å„²å­˜**: initramfs ä¸­çš„æª”æ¡ˆä½¿ç”¨ gzip å£“ç¸®
- **æŒ‰éœ€è¼‰å…¥**: åªæœ‰å¯¦éš›ä½¿ç”¨çš„æª”æ¡ˆæ‰æœƒè§£å£“ç¸®åˆ°è¨˜æ†¶é«”
- **å…±äº«é é¢**: ç›¸åŒæª”æ¡ˆåœ¨å¤šå€‹ç¨‹åºé–“å…±äº«è¨˜æ†¶é«”é é¢

### 4. ç¶­è­·ç°¡ä¾¿æ€§
- **å–®ä¸€æ˜ åƒæª”**: æ•´å€‹ç³»çµ±åŒ…å«åœ¨ä¸€å€‹ FIT Image ä¸­
- **åŸå­æ›´æ–°**: ç³»çµ±æ›´æ–°åªéœ€æ›¿æ› FIT Image
- **é…ç½®åˆ†é›¢**: ç³»çµ±æª”æ¡ˆèˆ‡ä½¿ç”¨è€…é…ç½®å®Œå…¨åˆ†é›¢

## é™¤éŒ¯å’Œç›£æ§

### é–‹æ©Ÿéç¨‹ç›£æ§
```bash
# æª¢è¦–é–‹æ©Ÿè¨Šæ¯
dmesg | grep -E "(init|mount|overlay)"

# æª¢è¦– systemd æœå‹™ç‹€æ…‹
systemctl status
systemctl list-failed

# æª¢è¦–æª”æ¡ˆç³»çµ±æ›è¼‰
findmnt -D
```

### æŒä¹…åŒ–å„²å­˜ç›£æ§
```bash
# æª¢è¦– UBIFS ç‹€æ…‹
ubinfo /dev/ubi0
ubinfo /dev/ubi0 -a

# æª¢è¦– overlay ä½¿ç”¨æƒ…æ³  
df -h /run/mnt-persist/
du -sh /run/mnt-persist/*-data/
```

### è¨˜æ†¶é«”ä½¿ç”¨ç›£æ§
```bash
# æª¢è¦–è¨˜æ†¶é«”è©³ç´°ä½¿ç”¨
cat /proc/meminfo

# æª¢è¦–ç¨‹åºè¨˜æ†¶é«”ä½¿ç”¨
ps aux --sort=-%mem | head -10

# æª¢è¦–æª”æ¡ˆç³»çµ±å¿«å–
cat /proc/sys/vm/drop_caches
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ

#### 1. æŒä¹…åŒ–åˆ†å‰²å€æå£
```bash
# ç—‡ç‹€: overlay æ›è¼‰å¤±æ•—
# è§£æ±º: é‡æ–°æ ¼å¼åŒ–æŒä¹…åŒ–åˆ†å‰²å€
fw_setenv openbmconce factory-reset
reboot
```

#### 2. è¨˜æ†¶é«”ä¸è¶³
```bash
# ç—‡ç‹€: æœå‹™å•Ÿå‹•å¤±æ•—ï¼ŒOOM Killer å•Ÿå‹•
# è§£æ±º: æª¢æŸ¥è¨˜æ†¶é«”æ´©æ¼ï¼Œé‡å•Ÿæœå‹™
systemctl restart phosphor-*
```

#### 3. æª”æ¡ˆç³»çµ±å”¯è®€éŒ¯èª¤
```bash
# ç—‡ç‹€: ç„¡æ³•å¯«å…¥ /var æˆ– /etc
# è§£æ±º: æª¢æŸ¥ overlay æ›è¼‰ç‹€æ…‹
findmnt /var /etc /home
umount /var && /etc/init.d/50-mount-persistent
```

é€™å€‹é–‹æ©Ÿæµç¨‹åˆ†æå±•ç¤ºäº† OpenBMC Yosemite4 çš„å‰µæ–°è¨­è¨ˆï¼Œé€é static-norootfs æ¶æ§‹å¯¦ç¾äº†é«˜æ•ˆã€ç©©å®šä¸”æ˜“æ–¼ç¶­è­·çš„ BMC ç³»çµ±ã€‚
